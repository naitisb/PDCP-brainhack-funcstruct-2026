#!/bin/bash
# Transforming DTI atlas into native space 
# MB NB EV JM KH January 2026 

# Check script arguments
args=2
usage() {
    COMMAND=$(basename $0)
    echo
    echo "Usage:"
    echo "./$COMMAND [session name] [subject_id]"
    echo
	echo "Example:"
	echo "./$COMMAND ses-02y sub-146"
echo
exit
}
[ $# -ne $args ] && { usage; exit; }

module load mrtrix3/3.0.8

# Set variables and paths
SES=$1
SUBJECT=$2

CURR_DIR=$(pwd)
ROOT_DIR="${CURR_DIR%/*/*/*}"
DATA_DIR="${ROOT_DIR}/data/derivatives"
ATLAS_DIR="${ROOT_DIR}/data/atlases/NITRC_1_2y_DTI"

echo "Root directory: $ROOT_DIR"
echo "Data directory: $DATA_DIR"

DTI_DIR="${DATA_DIR}/DTI/${SUBJECT}/${SES}/dwi"
FMRI_DIR="${DATA_DIR}/fMRI/${SUBJECT}/${SES}/func"
ROI_DIR="${DATA_DIR}/ROIs"

# Make results directory
RESULTS_DIR=${ROOT_DIR}/results/${SUBJECT}
WARP_DIR=${RESULTS_DIR}/warps
TRACTS_DIR=${RESULTS_DIR}/tracts


# Create warps and tracts directory if they don't exist
mkdir -p $WARP_DIR
mkdir -p $TRACTS_DIR

# # Convert atlas FA and DTI masked to MRtrix format
# mrconvert ${ATLAS_DIR}/PediatricAtlas_1_2y_FA.nrrd ${ATLAS_DIR}/PediatricAtlas_1_2y_FA.mif
# mrconvert ${ATLAS_DIR}/PediatricAtlas_1_2y_DTI_masked.nrrd ${ATLAS_DIR}/PediatricAtlas_1_2y_DTI_masked.mif


# Register atlas to subject space (if not already done)
# First register FA images
echo
echo "Registering atlas to subject space using FA map for ${SUBJECT}..."
echo
mrregister ${ATLAS_DIR}/PediatricAtlas_1_2y_FA.nii.gz ${DTI_DIR}/${SUBJECT}_ses-02y_desc-FA_mdp.nii.gz \
 -type rigid_affine_nonlinear -force \
 -nl_warp ${WARP_DIR}/atlas2_${SUBJECT}_warp.nii.gz ${WARP_DIR}/${SUBJECT}_2atlas_warp.nii.gz
echo
echo "Registration completed."
echo

echo "Warping DTI_masked atlas image to subject space for ${SUBJECT}..."
echo
# Warp DTI_masked atlas image to subject space
mrtransform ${ATLAS_DIR}/PediatricAtlas_1_2y_DTI_masked.nii.gz ${DTI_DIR}/PediatricAtlas_1_2y_DTI_masked_to_${SUBJECT}.mif \
 -warp ${WARP_DIR}/atlas2_${SUBJECT}_warp.nii.gz -interp nearest -force

echo "Warping FA atlas image to subject space for ${SUBJECT}..."
echo
 # Warp FA atlas image to subject space
mrtransform ${ATLAS_DIR}/PediatricAtlas_1_2y_FA.nii.gz ${DTI_DIR}/PediatricAtlas_1_2y_FA_to_${SUBJECT}.mif \
 -warp ${WARP_DIR}/atlas2_${SUBJECT}_warp.nii.gz -interp nearest -force
echo
echo "Warping complete."
echo

echo "Transforming atlas fibers to subject space for ${SUBJECT}..."
echo



# Convert atlas VTK fibers to TCK
for fiber in ${ATLAS_DIR}/Fibers/*.vtk; do
    name=$(basename ${fiber} .vtk)
    
    echo "Processing fiber: ${name}"
    echo
    # Convert VTK to TCK (may need tckconvert or custom script)
    tckconvert ${fiber} ${TRACTS_DIR}/atlas_${name}.tck
    
    # Transform to subject space
    tcktransform ${TRACTS_DIR}/atlas_${name}.tck \
        ${WARP_DIR}/atlas2_${SUBJECT}_warp.nii.gz \
        ${TRACTS_DIR}/atlas2_${SUBJECT}_${name}.tck

    echo "Transformed fiber saved as: atlas2_${SUBJECT}_${name}.tck"
    echo
done

echo "Atlas transformation to subject space completed for ${SUBJECT}."